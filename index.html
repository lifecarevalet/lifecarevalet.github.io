<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Life Care Valet Parking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-in-out; }
        .fixed-header { position: sticky; top: 0; z-index: 20; }
        .login-popup { animation: fadeIn 0.25s ease-out; }
        /* Professional Popups */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; transition: opacity 0.25s ease-in-out; }
        /* Token popup design */
        .token-popup .token-number { font-size: clamp(32px, 8vw, 72px); letter-spacing: 2px; }
        .token-popup .meta { font-size: 14px; }
        /* Login Title Style */
        .login-title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3b82f6; /* Blue-600 */
        }
        .login-subtitle {
            font-size: 1rem;
            color: #6b7280; /* Gray-500 */
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app-root" class="min-h-screen">
        </div>

<script>
    const API_BASE_URL = 'YOUR_API_BASE_URL_HERE'; // Replace with your actual API base URL

    // --- STATE ---
    let appRoot = document.getElementById('app-root');
    let user = JSON.parse(localStorage.getItem('user'));
    let currentTokens = [];
    let currentPoints = [];
    let allUsers = []; 
    let currentManagers = []; 
    let currentLoginRole = null;
    let isSplash = true; 

    // --- HELPERS ---

    // Utility function to make API calls
    async function apiCall(endpoint, method = 'GET', data = null) {
        const url = `${API_BASE_URL}/${endpoint}`;
        const headers = {
            'Content-Type': 'application/json',
            ...(user && user.token && { 'Authorization': `Bearer ${user.token}` })
        };
        const config = {
            method,
            headers,
            ...(data && { body: JSON.stringify(data) })
        };

        try {
            const response = await fetch(url, config);
            if (response.status === 401) {
                // Unauthorized, session expired
                handleLogout();
                return;
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `API call failed with status: ${response.status}`);
            }
            return response.json();
        } catch (error) {
            console.error("API Call Error:", error);
            throw error;
        }
    }

    // Custom Alert/Toast function
    function showCustomAlert(message, title = 'Notification', type = 'info') {
        const color = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        const alertHtml = `
            <div class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${color} animate-fadeIn" role="alert" id="custom-alert">
                <p class="font-bold">${title}</p>
                <p class="text-sm">${message}</p>
            </div>
        `;

        // Remove any existing alert
        const existingAlert = document.getElementById('custom-alert');
        if (existingAlert) existingAlert.remove();

        document.body.insertAdjacentHTML('beforeend', alertHtml);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            const newAlert = document.getElementById('custom-alert');
            if (newAlert) newAlert.remove();
        }, 3000);
    }
    
    function getUserPointDetails() {
        if (!user || !user.pointId) return null;
        return currentPoints.find(p => p._id === user.pointId);
    }

    function toggleSidebar(shouldOpen) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            if (shouldOpen) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
            }
        }
    }

    function renderSidebarMenu() {
        const isAdmin = user.role === 'admin'; 
        const isManager = user.role === 'manager';
        let links = [];

        if (isAdmin) {
            links.push({ text: 'Manage Users (M & D)', handler: 'renderUserList()' });
            links.push({ text: 'Add Manager', handler: 'renderUserManagement(\'manager\')' });
            links.push({ text: 'Add Driver', handler: 'renderUserManagement(\'driver\')' });
            links.push({ text: 'Manage Locations', handler: 'renderPointList()' });
        } else if (isManager) {
            links.push({ text: 'Manage Drivers', handler: 'renderManagerDriverList()' });
            links.push({ text: 'Add Driver', handler: 'renderUserManagement(\'driver\')' });
        }
        
        links.push({ text: 'Logout', handler: 'handleLogout()' });
        
        const linksHtml = links.map(link => `
            <li class="p-3 hover:bg-gray-700 rounded-md cursor-pointer transition-colors" onclick="${link.handler}; toggleSidebar(false);">
                ${link.text}
            </li>
        `).join('');

        return `
            <div id="sidebar" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity-75 md:static md:w-64 md:flex-shrink-0 md:bg-gray-800 md:flex flex-col text-white transform transition-transform duration-300">
                
                <div class="p-4 flex justify-between items-center bg-gray-700 md:hidden">
                    <h2 class="text-xl font-bold">Menu</h2>
                    <button class="text-white text-2xl" onclick="toggleSidebar(false)">
                        &times;
                    </button>
                </div>

                <div class="p-4 flex-grow">
                    <div class="text-xl font-bold mb-6 border-b pb-2">Life Care Valet</div>
                    <ul class="space-y-2">
                        <li class="p-3 hover:bg-gray-700 rounded-md cursor-pointer transition-colors" onclick="renderDashboard(); toggleSidebar(false);">
                            Dashboard
                        </li>
                        ${linksHtml}
                    </ul>
                </div>
                
                <div class="p-4 border-t border-gray-700">
                    <p class="text-sm">Logged in as: ${user.fullName || user.username}</p>
                    <p class="text-sm font-semibold">${user.role.toUpperCase()}</p>
                </div>
            </div>
        `;
    }

    // --- API FETCHERS ---

    async function fetchTokens() {
        try {
            const data = await apiCall('tokens/list');
            currentTokens = data.tokens;
        } catch (error) {
            showCustomAlert('Could not fetch tokens.', 'Error', 'error');
            console.error("Fetch Tokens Error:", error);
        }
    }

    async function fetchPoints() {
        try {
            const data = await apiCall('points');
            currentPoints = data.points;
        } catch (error) {
            showCustomAlert('Could not fetch locations.', 'Error', 'error');
            console.error("Fetch Points Error:", error);
        }
    }

    async function fetchAllUsersAndManagers() {
        try {
            const data = await apiCall('users/all');
            allUsers = data.users.filter(u => u.role !== 'admin'); // Filter out self (Admin)
            currentManagers = data.users.filter(u => u.role === 'manager');
        } catch (error) {
            showCustomAlert('Could not fetch user list.', 'Error', 'error');
            console.error("Fetch Users Error:", error);
            allUsers = [];
            currentManagers = [];
        }
    }

    async function fetchManagerDrivers() {
        try {
            const data = await apiCall(`users/manager-drivers/${user._id}`);
            return data.drivers;
        } catch (error) {
            showCustomAlert('Could not fetch your driver list.', 'Error', 'error');
            console.error("Fetch Manager Drivers Error:", error);
            return [];
        }
    }

    // --- RENDERERS ---

    function renderSplashScreen() {
        appRoot.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-white">
                <div class="text-center">
                    <div class="text-6xl font-extrabold text-blue-600 animate-pulse">
                        Life Care
                    </div>
                    <div class="text-2xl text-gray-500 mt-2">
                        Valet Parking
                    </div>
                </div>
            </div>
        `;
    }

    function renderUnifiedLogin() {
        appRoot.innerHTML = `
            <div class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                <div class="login-title-container">
                    <div class="login-logo">Life Care</div>
                    <div class="login-subtitle">Valet Parking - Login Role</div>
                </div>
                <div class="w-full max-w-xs space-y-4">
                    <button data-role="admin" class="role-btn w-full bg-blue-600 text-white py-3 rounded-lg shadow-md hover:bg-blue-700 font-semibold">ADMIN</button>
                    <button data-role="manager" class="role-btn w-full bg-yellow-600 text-white py-3 rounded-lg shadow-md hover:bg-yellow-700 font-semibold">MANAGER</button>
                    <button data-role="driver" class="role-btn w-full bg-green-600 text-white py-3 rounded-lg shadow-md hover:bg-green-700 font-semibold">DRIVER</button>
                </div>
            </div>
        `;
        
        document.querySelectorAll('.role-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const role = e.currentTarget.getAttribute('data-role');
                renderLoginPopup(role);
            });
        });
    }

    function renderLoginPopup(role) {
        currentLoginRole = role; // Set the current login attempt role
        const color = role === 'admin' ? 'blue' : (role === 'manager' ? 'yellow' : 'green');
        const roleTitle = role === 'admin' ? 'ADMIN' : role.toUpperCase();
        
        appRoot.innerHTML = `
            <div class="modal-backdrop login-popup">
                <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-${color}-600">${roleTitle} Login</h2>
                        <button onclick="renderUnifiedLogin()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
                    </div>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium text-gray-700">Username/Phone</label>
                            <input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-${color}-500 focus:border-${color}-500 sm:text-sm">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-${color}-500 focus:border-${color}-500 sm:text-sm">
                        </div>
                        <p id="error-message" class="text-red-500 text-sm mb-4 text-center"></p>
                        <button type="submit" class="w-full bg-${color}-600 text-white py-2 rounded-md hover:bg-${color}-700 transition duration-150 font-semibold">Login as ${roleTitle}</button>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
    }

    function renderUserManagement(role, userData = null) {
        const roleTitle = role.charAt(0).toUpperCase() + role.slice(1);
        const isAdmin = user.role === 'admin';
        const isManager = user.role === 'manager';
        const managersForSelect = currentManagers; 

        const managerPoint = getUserPointDetails();

        const isDriverCreationByAdmin = isAdmin && role === 'driver';

        appRoot.innerHTML = `
            <div class="flex min-h-screen">
                ${renderSidebarMenu()}
                <div class="flex-grow p-4 md:ml-64 bg-gray-50">
                    <header class="fixed-header w-full bg-white p-4 shadow-md flex items-center justify-between">
                        <button class="md:hidden text-gray-600 hover:text-gray-900" id="menu-toggle-btn">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold">Add ${roleTitle}</h1>
                        <button onclick="renderDashboard()" class="text-blue-600 hover:text-blue-800 font-medium">
                            &larr; Back to Dashboard
                        </button>
                    </header>
                    <main class="pt-20 p-4 max-w-xl mx-auto">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <form id="create-user-form">
                                <input type="hidden" name="role" value="${role}">
                                
                                <div class="mb-4">
                                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name (Required)</label>
                                    <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div class="mb-4">
                                    <label for="username" class="block text-sm font-medium text-gray-700">Username/Phone (Required)</label>
                                    <input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div class="mb-4">
                                    <label for="password" class="block text-sm font-medium text-gray-700">Password (Required)</label>
                                    <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                
                                ${isDriverCreationByAdmin ? `
                                    <div class="mb-4">
                                        <label for="managerId" class="block text-sm font-medium text-gray-700">Assign Manager (Required)</label>
                                        <select id="managerId" name="managerId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
                                            <option value="">-- Select Manager --</option>
                                            ${managersForSelect.map(m => `<option value="${m._id}">${m.fullName} (${m.username})</option>`).join('')}
                                        </select>
                                    </div>
                                ` : ''}

                                ${(isAdmin || (isManager && role === 'manager')) ? `
                                    <div class="mb-4" id="admin-point-container">
                                        <label for="pointId" class="block text-sm font-medium text-gray-700" id="admin-point-label">Assign Location (Point)</label>
                                        <select id="pointId" name="pointId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
                                            <option value="">-- Select Location --</option>
                                            ${currentPoints.map(p => `<option value="${p._id}">${p.name}</option>`).join('')}
                                        </select>
                                    </div>
                                ` : ''}

                                ${(isManager && role === 'driver') ? `
                                    <input type="hidden" name="managerId" value="${user._id}">
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700">Assigned Location</label>
                                        <input type="text" value="${managerPoint ? managerPoint.name : 'N/A'}" disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                                        <input type="hidden" name="pointId" value="${managerPoint ? managerPoint._id : ''}">
                                        ${!managerPoint ? '<p class="text-red-500 text-xs mt-1">Error: Manager must have an assigned location to add drivers.</p>' : ''}
                                    </div>
                                ` : ''}

                                <p id="creation-message" class="text-center text-sm mt-4"></p>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-150 font-semibold mt-4" ${!managerPoint && isManager && role === 'driver' ? 'disabled' : ''}>
                                    Create ${roleTitle}
                                </button>
                            </form>
                        </div>
                    </main>
                </div>
            </div>
        `;

        document.getElementById('menu-toggle-btn').addEventListener('click', () => toggleSidebar(true));
        document.getElementById('create-user-form').addEventListener('submit', handleCreateUserSubmit);
        
        // Request 2 & 5 Logic: Auto-assign Location based on Manager selection (Admin creating Driver)
        if (isDriverCreationByAdmin) {
            const managerSelect = document.getElementById('managerId');
            const pointSelect = document.getElementById('pointId');
            const pointContainer = document.getElementById('admin-point-container');
            const pointLabel = document.getElementById('admin-point-label');

            const updatePointBasedOnManager = () => {
                const selectedManagerId = managerSelect.value;
                const selectedManager = currentManagers.find(m => m._id === selectedManagerId);
                
                // Show the point container
                pointContainer.classList.remove('hidden');
                pointSelect.disabled = false;
                pointSelect.classList.remove('bg-gray-200');
                pointSelect.required = true;
                pointLabel.textContent = 'Assign Location (Point)';


                if (selectedManager) {
                    if (selectedManager.pointId) {
                        pointSelect.value = selectedManager.pointId;
                        pointSelect.disabled = true;
                        pointSelect.required = false;
                        pointLabel.textContent = 'Assign Location (Auto-filled from Manager)';
                        pointSelect.classList.add('bg-gray-200');
                    } else {
                        pointSelect.value = '';
                        pointSelect.disabled = true;
                        pointLabel.textContent = 'Assign Location (Selected Manager has no assigned Location)';
                        pointSelect.classList.remove('bg-gray-200');
                    }
                } else {
                    pointContainer.classList.add('hidden'); // Hide if no manager is selected
                    pointSelect.value = '';
                    pointSelect.disabled = false;
                    pointLabel.textContent = 'Assign Location (Point)';
                    pointSelect.classList.remove('bg-gray-200');
                }
            };

            managerSelect.addEventListener('change', updatePointBasedOnManager);
            updatePointBasedOnManager();
        }
    }


    function renderPointList() {
        appRoot.innerHTML = `
            <div class="flex min-h-screen">
                ${renderSidebarMenu()}
                <div class="flex-grow p-4 md:ml-64 bg-gray-50">
                    <header class="fixed-header w-full bg-white p-4 shadow-md flex items-center justify-between">
                        <button class="md:hidden text-gray-600 hover:text-gray-900" id="menu-toggle-btn">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold">Location Management (Points)</h1>
                        <button onclick="renderDashboard()" class="text-blue-600 hover:text-blue-800 font-medium">
                            &larr; Back to Dashboard
                        </button>
                    </header>
                    <main class="pt-20 p-4">
                        <div class="max-w-4xl mx-auto">
                            <button onclick="showAddPointModal()" class="mb-4 bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 font-semibold">
                                + Add New Location
                            </button>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold mb-4">Existing Locations</h2>
                                <div id="point-list-container">
                                    ${currentPoints.length === 0 ? '<p id="list-message" class="text-gray-500">No locations found.</p>' : renderPointTable(currentPoints)}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        `;
        document.getElementById('menu-toggle-btn').addEventListener('click', () => toggleSidebar(true));
    }

    function renderPointTable(points) {
        return `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Location Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${points.map(point => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${point.name}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <button onclick="handlePointDelete('${point._id}')" class="text-red-600 hover:text-red-900 ml-2">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async function showAddPointModal(point = null) {
        const title = point ? 'Edit Location' : 'Add New Location';
        const buttonText = point ? 'Save Changes' : 'Create Location';

        const modalHtml = `
            <div class="modal-backdrop" id="point-modal-backdrop">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <h2 class="text-xl font-bold mb-4">${title}</h2>
                    <form id="point-form">
                        ${point ? `<input type="hidden" name="pointId" value="${point._id}">` : ''}
                        <div class="mb-4">
                            <label for="pointName" class="block text-sm font-medium text-gray-700">Location Name (Required)</label>
                            <input type="text" id="pointName" name="name" value="${point ? point.name : ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <p id="point-message" class="text-center text-sm mt-4"></p>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="document.getElementById('point-modal-backdrop').remove()" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">${buttonText}</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('point-form').addEventListener('submit', handlePointSubmit);
    }

    async function renderUserList() {
        await fetchAllUsersAndManagers();
        appRoot.innerHTML = `
            <div class="flex min-h-screen">
                ${renderSidebarMenu()}
                <div class="flex-grow p-4 md:ml-64 bg-gray-50">
                    <header class="fixed-header w-full bg-white p-4 shadow-md flex items-center justify-between">
                        <button class="md:hidden text-gray-600 hover:text-gray-900" id="menu-toggle-btn">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold">User Management (Managers & Drivers)</h1>
                        <button onclick="renderDashboard()" class="text-blue-600 hover:text-blue-800 font-medium">
                            &larr; Back to Dashboard
                        </button>
                    </header>
                    <main class="pt-20 p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h2 class="text-lg font-semibold mb-4">All Users (Except Admin)</h2>
                                <div id="user-list-container">
                                    ${allUsers.length === 0 ? '<p id="list-message" class="text-gray-500">No users found (Managers or Drivers).</p>' : ''}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        `;

        document.getElementById('menu-toggle-btn').addEventListener('click', () => toggleSidebar(true));
        
        const container = document.getElementById('user-list-container');
        try {
            const usersToShow = allUsers.filter(u => u.role !== 'admin');
            if (usersToShow.length > 0) {
                 document.getElementById('list-message')?.remove();
                 container.insertAdjacentHTML('beforeend', renderUserTable(usersToShow));
            }
        } catch (err) {
            console.error("Rendering user list error:", err);
        }
    }

    async function renderManagerDriverList() {
        await fetchTokens(); // Fetch tokens to link to tokens
        const drivers = await fetchManagerDrivers();

        appRoot.innerHTML = `
            <div class="flex min-h-screen">
                ${renderSidebarMenu()}
                <div class="flex-grow p-4 md:ml-64 bg-gray-50">
                    <header class="fixed-header w-full bg-white p-4 shadow-md flex items-center justify-between">
                        <button class="md:hidden text-gray-600 hover:text-gray-900" id="menu-toggle-btn">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 class="text-xl font-semibold">My Drivers & Tokens</h1>
                        <button onclick="renderDashboard()" class="text-blue-600 hover:text-blue-800 font-medium">
                            &larr; Back to Dashboard
                        </button>
                    </header>
                    <main class="pt-20 p-4">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-lg font-semibold mb-3">Drivers Under My Management</h2>
                            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                                <div id="driver-list-container">
                                    ${drivers.length === 0 ? '<p class="text-gray-500">No drivers assigned to you.</p>' : renderUserTable(drivers)}
                                </div>
                            </div>

                            <h2 class="text-lg font-semibold mb-3">Tokens Created by Me & My Drivers</h2>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                ${currentTokens.length === 0 ? '<p class="text-gray-500">No tokens found in your area.</p>' : renderTokenTable(currentTokens)}
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        `;

        document.getElementById('menu-toggle-btn').addEventListener('click', () => toggleSidebar(true));
    }

    function renderUserTable(users) {
        return `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Username
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Role
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Location
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${users.map(u => {
                            const point = currentPoints.find(p => p._id === u.pointId);
                            const locationName = point ? point.name : 'N/A';
                            return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        ${u.fullName}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${u.username}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.role === 'manager' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                            ${u.role.toUpperCase()}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${locationName}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="showEditUserModal('${u._id}')" class="text-blue-600 hover:text-blue-900">Edit</button>
                                        <button onclick="handleUserDelete('${u._id}')" class="text-red-600 hover:text-red-900 ml-2">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderTokenTable(tokens) {
        return `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Token No.
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Vehicle No.
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tokens.map(token => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${token.tokenNumber}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${token.vehicleNumber}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${token.status === 'parked' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                                        ${token.status.toUpperCase()}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="showTokenDetailsModal('${token._id}')" class="text-blue-600 hover:text-blue-900">View/Edit</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async function showTokenDetailsModal(tokenId) {
        const token = currentTokens.find(t => t._id === tokenId);
        if (!token) return;

        const isParked = token.status === 'parked';
        const modalTitle = `Token #${token.tokenNumber}`;
        const driver = allUsers.find(u => u._id === token.driverId);
        const owner = allUsers.find(u => u._id === token.ownerId) || user; // Fallback to current user if ownerId matches
        const point = currentPoints.find(p => p._id === token.pointId);

        const modalHtml = `
            <div class="modal-backdrop" id="token-details-modal-backdrop">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg token-popup">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold">${modalTitle}</h2>
                        <button onclick="document.getElementById('token-details-modal-backdrop').remove()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
                    </div>

                    <div class="text-center mb-6 border-b pb-4">
                        <p class="token-number font-mono text-blue-600">${token.vehicleNumber}</p>
                        <span class="px-3 py-1 mt-2 inline-flex text-sm leading-5 font-bold rounded-full ${isParked ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                            STATUS: ${token.status.toUpperCase()}
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                        <div class="meta"><strong>Customer Name:</strong> ${token.customerName}</div>
                        <div class="meta"><strong>Phone:</strong> ${token.customerPhone}</div>
                        <div class="meta"><strong>Location:</strong> ${point ? point.name : 'N/A'}</div>
                        <div class="meta"><strong>Driver:</strong> ${driver ? driver.fullName : 'N/A'}</div>
                        <div class="meta"><strong>Time In:</strong> ${new Date(token.timeIn).toLocaleString()}</div>
                        <div class="meta"><strong>Time Out:</strong> ${token.timeOut ? new Date(token.timeOut).toLocaleString() : 'N/A'}</div>
                        <div class="meta"><strong>Remarks:</strong> ${token.remarks || 'N/A'}</div>
                        <div class="meta"><strong>Created By:</strong> ${owner ? owner.fullName : 'N/A'}</div>
                    </div>

                    ${isParked ? `
                        <form id="token-edit-form" class="mt-4">
                            <input type="hidden" name="tokenId" value="${tokenId}">
                            <input type="hidden" name="action" value="return">
                            <div class="mb-4">
                                <label for="timeOutRemarks" class="block text-sm font-medium text-gray-700">Return Remarks (Optional)</label>
                                <textarea id="timeOutRemarks" name="timeOutRemarks" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                            </div>
                            <p id="token-edit-message" class="text-center text-sm mt-4"></p>
                            <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 font-semibold">
                                Return Vehicle (Mark as Collected)
                            </button>
                        </form>
                    ` : '<p class="text-center text-green-600 font-semibold mt-4">Vehicle has been returned.</p>'}
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        if (isParked) {
            document.getElementById('token-edit-form').addEventListener('submit', handleTokenEditSubmit);
        }
    }

    async function showCreateTokenModal() {
        const isDriver = user.role === 'driver';
        const pointDetails = getUserPointDetails();

        const modalHtml = `
            <div class="modal-backdrop" id="create-token-modal-backdrop">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-xl font-bold text-blue-600">Create New Token</h2>
                        <button onclick="document.getElementById('create-token-modal-backdrop').remove()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
                    </div>

                    <form id="create-token-form">
                        <input type="hidden" name="driverId" value="${user._id}">
                        <input type="hidden" name="ownerId" value="${user._id}">
                        ${isDriver && pointDetails ? `<input type="hidden" name="pointId" value="${pointDetails._id}">` : ''}

                        <div class="mb-4">
                            <label for="vehicleNumber" class="block text-sm font-medium text-gray-700">Vehicle No. (Required)</label>
                            <input type="text" id="vehicleNumber" name="vehicleNumber" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm uppercase">
                        </div>
                        <div class="mb-4">
                            <label for="customerName" class="block text-sm font-medium text-gray-700">Customer Name (Required)</label>
                            <input type="text" id="customerName" name="customerName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="customerPhone" class="block text-sm font-medium text-gray-700">Customer Phone (Optional)</label>
                            <input type="text" id="customerPhone" name="customerPhone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="remarks" class="block text-sm font-medium text-gray-700">Remarks (Optional)</label>
                            <textarea id="remarks" name="remarks" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        
                        ${!pointDetails && isDriver ? '<p class="text-red-500 text-xs mb-4">Error: You must be assigned to a location to create a token.</p>' : ''}
                        
                        <p id="token-creation-message" class="text-center text-sm mt-4"></p>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 font-semibold mt-4" ${!pointDetails && isDriver ? 'disabled' : ''}>
                            Generate Token
                        </button>
                    </form>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('create-token-form').addEventListener('submit', handleCreateTokenSubmit);
    }

    function renderDashboard() {
        if (!user) return renderUnifiedLogin();

        const isAdmin = user.role === 'admin';
        const isManager = user.role === 'manager';
        const isDriver = user.role === 'driver';

        // Fetch data first
        fetchTokens();
        if (isAdmin || isManager) {
            fetchPoints();
            fetchAllUsersAndManagers();
        }

        const pointDetails = getUserPointDetails();
        const parkedTokens = currentTokens.filter(t => t.status === 'parked');
        const returnedTokens = currentTokens.filter(t => t.status === 'returned');
        const totalTokens = currentTokens.length;

        appRoot.innerHTML = `
            <div class="flex min-h-screen">
                ${renderSidebarMenu()}
                <div class="flex-grow p-4 md:ml-64 bg-gray-50">
                    <header class="fixed-header w-full bg-white p-4 shadow-md flex items-center justify-between">
                        <button class="md:hidden text-gray-600 hover:text-gray-900" id="menu-toggle-btn">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <div class="flex items-center">
                            ${(isAdmin || isManager) ? `
                                <div class="mr-4 text-sm font-medium text-gray-600">
                                    Location: ${pointDetails ? pointDetails.name : 'All'}
                                </div>
                            ` : ''}
                            <h1 class="text-xl font-semibold">Dashboard - ${user.role.toUpperCase()}</h1>
                        </div>
                        <button onclick="showCreateTokenModal()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold text-sm">
                            + New Token
                        </button>
                    </header>
                    <main class="pt-20 p-4 grid grid-cols-1 ${isDriver || isManager ? 'md:grid-cols-3 gap-4' : 'max-w-4xl mx-auto'}">
                        
                        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-lg font-medium text-gray-500">Total Tokens</h3>
                            <p class="text-4xl font-bold text-gray-900 mt-1">${totalTokens}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-lg font-medium text-gray-500">Currently Parked</h3>
                            <p class="text-4xl font-bold text-blue-600 mt-1">${parkedTokens.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-lg font-medium text-gray-500">Vehicles Returned</h3>
                            <p class="text-4xl font-bold text-red-600 mt-1">${returnedTokens.length}</p>
                        </div>
                        
                        <div class="md:col-span-${isDriver || isManager ? '3' : '1'} bg-white p-6 rounded-lg shadow-lg mt-4">
                            <h2 class="text-xl font-semibold mb-4">Live Tokens (${parkedTokens.length})</h2>
                            <div id="token-list-container">
                                ${parkedTokens.length === 0 ? '<p class="text-gray-500">No vehicles are currently parked in your area.</p>' : renderTokenTable(parkedTokens)}
                            </div>
                        </div>

                    </main>
                </div>
            </div>
        `;

        if (isAdmin || isManager || isDriver) {
            document.getElementById('menu-toggle-btn').addEventListener('click', () => toggleSidebar(true));
        }
    }

    // --- API HANDLERS ---

    async function handleLoginSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const username = form.username.value.trim();
        const password = form.password.value;
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = '';

        try {
            const data = await apiCall('users/login', 'POST', { username, password });
            
            // Successful login
            const actualRole = data.user.role; 
            
            // Get the role button the user pressed
            const selectedRole = currentLoginRole; 

            // Role mismatch check only for DRIVER and MANAGER logins. 
            // ADMIN login (ADMIN button) is always allowed if credentials are correct.
            if (selectedRole !== 'admin' && selectedRole !== actualRole) {
                 errorMessage.textContent = `Error: Role mismatch. Aapne ${selectedRole.toUpperCase()} chuna hai lekin yeh credentials ${actualRole.toUpperCase()} ke hain. Kripya sahi role chunein ya Admin se contact karein.`;
                 // Prevent login continuation
                 return; 
            }
            
            user = data.user;
            user.token = data.token;
            localStorage.setItem('user', JSON.stringify(user));
            renderDashboard();
            showCustomAlert('Login Successful!', 'Success', 'success');

        } catch (error) {
            errorMessage.textContent = error.message || 'Login failed. Please check your username and password.';
        }
    }

    async function handlePointSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const pointId = form.pointId ? form.pointId.value : null;
        const name = form.name.value.trim();
        const messageElement = document.getElementById('point-message');
        messageElement.textContent = '';

        const payload = { name };
        let method = pointId ? 'PUT' : 'POST';
        let endpoint = pointId ? `points/${pointId}` : 'points';

        try {
            await apiCall(endpoint, method, payload);
            showCustomAlert(`Location ${pointId ? 'updated' : 'created'} successfully!`, 'Success', 'success');
            document.getElementById('point-modal-backdrop').remove();
            await fetchPoints();
            renderPointList(); // Re-render the list

        } catch (error) {
            messageElement.className = 'text-red-500 text-sm mt-3 text-center';
            messageElement.textContent = error.message || `Failed to ${pointId ? 'update' : 'create'} location.`;
        }
    }

    async function handlePointDelete(pointId) {
        if (!confirm('Are you sure you want to delete this location?')) return;

        try {
            await apiCall(`points/${pointId}`, 'DELETE');
            showCustomAlert('Location deleted successfully!', 'Success', 'success');
            await fetchPoints();
            renderPointList();

        } catch (error) {
            showCustomAlert(error.message || 'Failed to delete location.', 'Error', 'error');
        }
    }

    async function handleCreateUserSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const messageElement = document.getElementById('creation-message');
        messageElement.textContent = '';
        
        const role = form.role.value;
        const fullName = form.fullName.value.trim();
        const username = form.username.value.trim();
        const password = form.password.value;
        const pointId = form.pointId ? form.pointId.value : (user.role === 'manager' && getUserPointDetails() ? getUserPointDetails()._id : null);
        const managerId = form.managerId ? form.managerId.value : user._id;

        const payload = {
            fullName,
            username,
            password,
            role,
            ...(pointId && { pointId }),
            ...(role === 'driver' && { managerId }),
            ownerId: user._id // The user creating the account (Manager or Admin)
        };

        if (user.role === 'admin' && role === 'driver' && !payload.managerId) {
            messageElement.className = 'text-red-500 text-sm mt-3 text-center';
            messageElement.textContent = 'Error: Driver must be assigned to a Manager by Admin.';
            return;
        }

        try {
            await apiCall('users/register', 'POST', payload);
            showCustomAlert(`${role.charAt(0).toUpperCase() + role.slice(1)} created successfully!`, 'Success', 'success');
            
            // Clear form and navigate back
            form.reset();
            if (user.role === 'admin') renderUserList();
            else if (user.role === 'manager') renderManagerDriverList();

        } catch (error) {
            messageElement.className = 'text-red-500 text-sm mt-3 text-center';
            messageElement.textContent = error.message || 'User creation failed.';
        }
    }

    async function handleUserDelete(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

        try {
            await apiCall(`users/${userId}`, 'DELETE');
            showCustomAlert('User deleted successfully.', 'Success', 'success');
            await fetchAllUsersAndManagers();
            if (user.role === 'admin') renderUserList();
            else if (user.role === 'manager') renderManagerDriverList();

        } catch (error) {
            showCustomAlert(error.message || 'Failed to delete user.', 'Error', 'error');
        }
    }

    async function showEditUserModal(userId) {
        if (user.role === 'admin') {
            await fetchPoints();
            await fetchAllUsersAndManagers();
        } else if (user.role === 'manager') {
            await fetchPoints();
        }

        const userToEdit = allUsers.find(u => u._id === userId);
        if (!userToEdit) {
            showCustomAlert('User not found for editing.', 'Error', 'error');
            return;
        }

        const isUserADriver = userToEdit.role === 'driver';
        const isUserAManager = userToEdit.role === 'manager';
        const isAdmin = user.role === 'admin';
        const isManager = user.role === 'manager';

        const pointOptions = currentPoints.map(p => 
            `<option value="${p._id}" ${p._id === userToEdit.pointId ? 'selected' : ''}>${p.name}</option>`
        ).join('');
        
        const managerOptions = currentManagers.map(m => 
            `<option value="${m._id}" ${m._id === userToEdit.managerId ? 'selected' : ''}>${m.fullName} (${m.username})</option>`
        ).join('');

        const modalHtml = `
            <div class="modal-backdrop" id="edit-user-modal-backdrop">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">Edit ${userToEdit.role.toUpperCase()}</h2>
                    <form id="edit-user-form">
                        <input type="hidden" name="userId" value="${userId}">

                        <div class="mb-4">
                            <label for="editFullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="editFullName" name="fullName" value="${userToEdit.fullName}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="editUsername" class="block text-sm font-medium text-gray-700">Username/Phone</label>
                            <input type="text" id="editUsername" name="username" value="${userToEdit.username}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="editPassword" class="block text-sm font-medium text-gray-700">New Password (Optional)</label>
                            <input type="password" id="editPassword" name="password" placeholder="Leave blank to keep current password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>

                        ${(isUserAManager && isAdmin) || (isUserADriver && (isAdmin || isManager)) ? `
                            <div class="mb-4">
                                <label for="editPointId" class="block text-sm font-medium text-gray-700">Assign Location</label>
                                <select id="editPointId" name="pointId" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
                                    <option value="">-- Select Location --</option>
                                    ${pointOptions}
                                </select>
                            </div>
                        ` : ''}

                        ${isUserADriver && isAdmin ? `
                            <div class="mb-4">
                                <label for="editManagerId" class="block text-sm font-medium text-gray-700">Assign Manager</label>
                                <select id="editManagerId" name="managerId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm">
                                    <option value="">-- Select Manager --</option>
                                    ${managerOptions}
                                </select>
                            </div>
                        ` : ''}

                        <p id="edit-user-message" class="text-center text-sm mt-4"></p>
                        <div class="flex justify-end space-x-2 mt-4">
                            <button type="button" onclick="document.getElementById('edit-user-modal-backdrop').remove()" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('edit-user-form').addEventListener('submit', handleEditUserSubmit);
    }

    async function handleEditUserSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const userId = form.userId.value;
        const messageElement = document.getElementById('edit-user-message');
        messageElement.textContent = '';
        
        const payload = {
            fullName: form.fullName.value.trim(),
            username: form.username.value.trim(),
            ...(form.password.value && { password: form.password.value }),
            ...(form.pointId && { pointId: form.pointId.value }),
            ...(form.managerId && { managerId: form.managerId.value }),
        };

        try {
            const data = await apiCall(`users/${userId}`, 'PUT', payload);
            
            // Update local user state if we edited ourselves
            if (user._id === userId) {
                user = { ...user, ...data.user };
                localStorage.setItem('user', JSON.stringify(user));
            }
            
            showCustomAlert('User updated successfully!', 'Success', 'success');
            document.getElementById('edit-user-modal-backdrop').remove();
            
            // Re-render the appropriate list view
            await fetchAllUsersAndManagers();
            if (user.role === 'admin') renderUserList();
            else if (user.role === 'manager') renderManagerDriverList();
            else renderDashboard(); // For self-edit

        } catch (error) {
            messageElement.className = 'text-red-500 text-sm mt-3 text-center';
            messageElement.textContent = error.message || 'User update failed.';
        }
    }

    async function handleCreateTokenSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const messageElement = document.getElementById('token-creation-message');
        messageElement.textContent = '';
        
        const payload = {
            vehicleNumber: form.vehicleNumber.value.trim().toUpperCase(),
            customerName: form.customerName.value.trim(),
            customerPhone: form.customerPhone.value.trim(),
            remarks: form.remarks.value.trim(),
            driverId: form.driverId.value,
            ownerId: form.ownerId.value,
            pointId: form.pointId.value 
        };

        try {
            const data = await apiCall('tokens', 'POST', payload);
            showCustomAlert(`Token #${data.token.tokenNumber} created!`, 'Success', 'success');
            
            document.getElementById('create-token-modal-backdrop').remove();
            renderDashboard(); 

        } catch (error) {
            messageElement.className = 'text-red-500 text-sm mt-3 text-center';
            messageElement.textContent = error.message || 'Token creation failed.';
        }
    }

    async function handleTokenEditSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const tokenId = form.tokenId.value;
        const action = form.action.value;
        const messageElement = document.getElementById('token-edit-message');
        messageElement.textContent = '';
        
        let payload = {};
        let endpoint = `tokens/${tokenId}`;
        let method = 'PUT';
        let successMessage = '';

        if (action === 'return') {
            payload = {
                status: 'returned',
                timeOutRemarks: form.timeOutRemarks.value.trim()
            };
            successMessage = 'Vehicle marked as returned.';
        } else {
            return; // Unknown action
        }

        try {
            await apiCall(endpoint, method, payload);
            showCustomAlert(successMessage, 'Success', 'success');
            
            document.getElementById('token-details-modal-backdrop').remove();
            renderDashboard(); // Refresh dashboard

        } catch (error) {
            messageElement.className = 'text-red-500 text-sm mt-3 text-center';
            messageElement.textContent = error.message || 'Token update failed.';
        }
    }

    async function populateManagerDriverSelect() {
        try {
            const select = document.getElementById('driverSelect');
            if (!select) return;

            let drivers = [];
            if (user.role === 'manager') {
                // Use the new endpoint for fetching manager's drivers
                drivers = await fetchManagerDrivers();
            } else if (user.role === 'admin') {
                if (!allUsers || allUsers.length === 0) await fetchAllUsersAndManagers();
                drivers = (allUsers || []).filter(u => u.role === 'driver');
            }

            // Option for self (manager themselves)
            const youOption = `<option value="${user._id}">${user.fullName || user.username} (You as Driver)</option>`;

            const driversHtml = drivers.map(d => `<option value="${d._id}">${d.fullName} (${d.username})</option>`).join('');

            select.innerHTML = `<option value="">-- Select Driver --</option>` + youOption + driversHtml;
        } catch (err) {
            console.error("Failed to populate driver select:", err);
            showCustomAlert('Could not load driver list.', 'Error', 'error');
        }
    }

    async function handleLogout() {
        user = null;
        localStorage.removeItem('user');
        currentTokens = [];
        currentPoints = [];
        currentManagers = [];
        allUsers = [];
        renderApp();
    }

    // --- INIT / APP ---
    function renderApp() {
        if (isSplash) renderSplashScreen();
        else if (user) renderDashboard();
        else renderUnifiedLogin(); 
    }

    // start
    renderSplashScreen();
    setTimeout(() => {
        isSplash = false;
        renderApp();
    }, 800);

    // Attach listener for the new token edit modal form
    document.addEventListener('DOMContentLoaded', () => {
        const tokenEditForm = document.getElementById('token-edit-form');
        if (tokenEditForm) {
            tokenEditForm.addEventListener('submit', handleTokenEditSubmit);
        }
    });

</script>
</body>
</html>
